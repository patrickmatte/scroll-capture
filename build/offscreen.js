(()=>{"use strict";function e(e){return e<10?"0"+e:e.toString()}function o(o){let t=o.getHours(),i=t>=12?"pm":"am";return t%=12,t=t||12,{hours:t,minutes:e(o.getMinutes()),seconds:e(o.getSeconds()),ampm:i}}let t;function i(t){const i=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ScrollCapture",i=new Date,a=o(i),r={year:i.getFullYear(),month:e(i.getMonth()+1),date:e(i.getDate())};return a.ampm=a.ampm.toUpperCase(),`${t} ${r.year}-${r.month}-${r.date} at ${a.hours}.${a.minutes}.${a.seconds} ${a.ampm}`}(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ScrollCapture");return`${i}.${t}`}let a,r,n=[];const s=FFmpeg.createFFmpeg({corePath:chrome.runtime.getURL("ffmpeg-core.js"),log:!1,mainName:"main"});function c(e){const o={type:"scrollCaptureShowMainPanel",tabId:e};chrome.runtime.sendMessage(o,(e=>{console.log("errorResponse",e)}))}function d(e,o){const t={type:"scrollCaptureVideoURLBackground",videoURL:URL.createObjectURL(e),fileName:i(o.extension),tabId:o.tabId,mimeType:(o.exportVideo?"video":"audio")+"/"+o.extension};console.log("!!!!!!! sendBlob",t),chrome.runtime.sendMessage(t)}s.setProgress((e=>{console.log("progress:",e)})),s.setLogger((e=>{switch(e.type){case"fferr":case"ffout":const o={type:"scrollCaptureFFmpegLogToSW",logType:e.type,message:e.message,tabId:r};chrome.runtime.sendMessage(o)}})),chrome.runtime.onMessage.addListener((e=>{if("offscreen"===e.target)switch(e.type){case"scrollCaptureStartOffscreenRecording":!async function(e){if(r=e.tabId,"recording"===t?.state)throw new Error("Called startRecording while recording is in progress.");console.log("startRecording",JSON.stringify(e));const o={x:e.tabWidth,y:e.tabHeight},i=e.pixelRatio;let l,g={};if("tab"===e.mediaSource){const t=[{width:Math.floor(o.x),height:Math.floor(o.y)},{width:Math.floor(o.x*e.zoomLevel),height:Math.floor(o.y*e.zoomLevel)},{width:Math.floor(o.x*i),height:Math.floor(o.y*i)}];t.sort(((e,o)=>e.width*e.height-o.width*o.height)),console.log("constraintSizes",t),e.exportVideo&&(g.video={mandatory:{chromeMediaSource:e.mediaSource,chromeMediaSourceId:e.streamId,minWidth:t[0].width,minHeight:t[0].height,maxWidth:t[2].width,maxHeight:t[2].height,minFrameRate:30,maxFrameRate:60}}),e.exportAudio&&(g.audio={mandatory:{chromeMediaSource:e.mediaSource,chromeMediaSourceId:e.streamId}}),console.log("navigator.mediaDevices.getUserMedia",JSON.stringify(g));try{l=await navigator.mediaDevices.getUserMedia(g)}catch(e){console.log("navigator.mediaDevices.getUserMedia error",e)}}else{g={video:{displaySurface:"monitor"},audio:{suppressLocalAudioPlayback:!0,autoGainControl:!1,echoCancellation:!1,gooAutoGainControl:!1,noiseSuppression:!1},preferCurrentTab:!1,selfBrowserSurface:"exclude",systemAudio:"include",surfaceSwitching:"include",monitorTypeSurfaces:"include"},console.log("navigator.mediaDevices.getDisplayMedia",JSON.stringify(g));try{l=await navigator.mediaDevices.getDisplayMedia(g)}catch(e){console.log("navigator.mediaDevices.getDisplayMedia error",e)}}if(console.log("media=",l),!l)return console.log("!!!!No media"),void c(e.tabId);const u=l.getAudioTracks();if(e.exportAudio&&u.length>0){const e=new AudioContext;e.createMediaStreamSource(l).connect(e.destination)}if(!e.exportVideo&&e.exportAudio&&u.length<1)return console.log("!!!!No audio track"),l.getTracks().forEach((e=>e.stop())),void c(e.tabId);let m,h=e.format,p=e.audioCodec;e.needsFFMPEG&&(h="webm",p="pcm");e.exportVideo?(m=`video/${h};codecs=${e.videoCodec}`,e.exportAudio&&(m+=`,${p}`)):m=`audio/${h};codecs=${p}`;let f=e.videoBitsPerSecond||16,w=e.audioBitsPerSecond||128;const y={mimeType:m,audioBitsPerSecond:1e3*w,videoBitsPerSecond:1e6*f};console.log("MediaRecorder",JSON.stringify(y)),t=new MediaRecorder(l,y),t.ondataavailable=e=>n.push(e.data),t.onstop=()=>{const o=m.split(";")[0];a=new Blob(n,{type:o}),e.needsFFMPEG?function(e,o){var t=new FileReader;t.onload=async function(){let e="sample_video.webm",t=`sample_video.${o.extension}`,i=`ffmpeg -i ${e}`;o.exportVideo&&(i+=" -c:v copy"),o.exportAudio&&(i+=` -c:a ${o.audioCodec} -b:a ${o.audioBitsPerSecond}k`),i+=` ${t}`;const a=await async function(e,o,t,i){s.isLoaded()&&await s.exit();await s.load();const a=t.split(" ");if("ffmpeg"!==a.shift())return void alert("Please start with ffmpeg");s.FS("writeFile",e,await FFmpeg.fetchFile(i)),await s.run(...a);const r=s.FS("readFile",o),n=new Blob([r.buffer]);return n}(e,t,i,new Uint8Array(this.result));d(a,o)},t.readAsArrayBuffer(e)}(a,e):d(a,e),n=[]},t.start(),window.location.hash="recording"}(e);break;case"scrollCaptureStopOffscreenRecording":t.stop(),t.stream.getTracks().forEach((e=>e.stop())),t=void 0,window.location.hash="";break;default:throw new Error("Unrecognized message:",e.type)}}))})();