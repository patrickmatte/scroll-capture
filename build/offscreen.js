(()=>{"use strict";function e(e){return e<10?"0"+e:e.toString()}function o(o){let t=o.getHours(),a=t>=12?"pm":"am";return t%=12,t=t||12,{hours:t,minutes:e(o.getMinutes()),seconds:e(o.getSeconds()),ampm:a}}function t(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Scroll Capture",a=new Date,i=o(a),r=a.getFullYear(),n=e(a.getMonth()+1),s=e(a.getDate());return i.ampm=i.ampm.toUpperCase(),`${t} ${r}-${n}-${s} at ${i.hours}.${i.minutes}.${i.seconds} ${i.ampm}`}const{createFFmpeg:a,fetchFile:i}=FFmpeg,r=a({corePath:chrome.runtime.getURL("ffmpeg-core.js"),log:!0,mainName:"main"});let n;chrome.runtime.onMessage.addListener((e=>{if("offscreen"===e.target)switch(e.type){case"scrollCaptureStartOffscreenRecording":!async function(e){if("recording"===n?.state)throw new Error("Called startRecording while recording is in progress.");console.log("startRecording",JSON.stringify(e));const o={x:e.tabWidth,y:e.tabHeight},a=e.pixelRatio,d={};e.exportVideo&&(d.video={mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e.streamId,minWidth:Math.min(o.x,o.x*e.zoomLevel),maxWidth:o.x*a,minHeight:Math.min(o.y,o.y*e.zoomLevel),maxHeight:o.y*a,minFrameRate:30,maxFrameRate:60}});e.exportAudio&&(d.audio={mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e.streamId}});console.log("navigator.mediaDevices.getUserMedia",JSON.stringify(d));const m=await navigator.mediaDevices.getUserMedia(d);if(console.log("media=",m),e.exportAudio){const e=new AudioContext;e.createMediaStreamSource(m).connect(e.destination)}let l;e.exportVideo?(l="video/webm;codecs=h264",e.exportAudio&&(l+=",opus")):l="audio/webm;codecs=opus";let g=e.videoBitsPerSecond||16,p=e.audioBitsPerSecond||128;const u={mimeType:l,audioBitsPerSecond:1e3*p,videoBitsPerSecond:1e6*g};console.log("MediaRecorder",JSON.stringify(u)),n=new MediaRecorder(m,u),n.ondataavailable=e=>c.push(e.data),n.onstop=()=>{console.log("data=",c);const o=l.split(";")[0];console.log("blobFormat=",o),s=new Blob(c,{type:o}),console.log("blob=",s),function(e,o){var a=new FileReader;a.onload=async function(){let e,a="sample_video.webm",n="sample_video.mp4",s="mp4";o.exportVideo?e=o.exportAudio?`ffmpeg -i ${a} -c:v copy -c:a aac ${n}`:`ffmpeg -i ${a} -c:v copy ${n}`:(s="m4a",n="sample_video.m4a",e=`ffmpeg -i ${a} -c:a aac ${n}`);const c=`${t()}.${s}`,d=await async function(e,o,t,a){console.log("runFFmpeg commandStr",t),r.isLoaded()&&await r.exit();await r.load();const n=t.split(" ");if("ffmpeg"!==n.shift())return void alert("Please start with ffmpeg");r.FS("writeFile",e,await i(a)),await r.run(...n);const s=r.FS("readFile",o);console.log("ffmpeg data",s);const c=new Blob([s.buffer]);return console.log("ffmpeg blob",c),c}(a,n,e,new Uint8Array(this.result));console.log("runFFmpeg blob",d);const m={type:"scrollCaptureVideoURLBackground",videoURL:URL.createObjectURL(d),fileName:c,tabId:o.tabId,mimeType:`video/${s}`};console.log("videoURLMessage",m),chrome.runtime.sendMessage(m)},a.readAsArrayBuffer(e)}(s,e),c=[]},n.start(),window.location.hash="recording"}(e);break;case"scrollCaptureStopOffscreenRecording":n.stop(),n.stream.getTracks().forEach((e=>e.stop())),n=void 0,window.location.hash="";break;default:throw new Error("Unrecognized message:",e.type)}}));let s,c=[]})();