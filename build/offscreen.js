(()=>{"use strict";function e(e){return e<10?"0"+e:e.toString()}let o;function t(o){const t=function(){let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ScrollCapture",t=new Date,i=function(o){return{hours:o.getHours(),minutes:e(o.getMinutes()),seconds:e(o.getSeconds())}}(t),r={year:t.getFullYear(),month:e(t.getMonth()+1),date:e(t.getDate())};return`${o} ${r.year}-${r.month}-${r.date} at ${i.hours}.${i.minutes}.${i.seconds}`}(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ScrollCapture");return`${t}.${o}`}let i,r,a=[];const n=FFmpeg.createFFmpeg({corePath:chrome.runtime.getURL("ffmpeg-core.js"),log:!1,mainName:"main"});function s(e){const o={type:"scrollCaptureShowMainPanel",tabId:e};chrome.runtime.sendMessage(o,(e=>{console.log("errorResponse",e)}))}function c(e,o){const i={type:"scrollCaptureVideoURLBackground",videoURL:URL.createObjectURL(e),fileName:t(o.extension),tabId:o.tabId,mimeType:(o.exportVideo?"video":"audio")+"/"+o.extension};console.log("!!!!!!! sendBlob",i),chrome.runtime.sendMessage(i)}n.setProgress((e=>{console.log("progress:",e)})),n.setLogger((e=>{switch(e.type){case"fferr":case"ffout":const o={type:"scrollCaptureFFmpegLogToSW",logType:e.type,message:e.message,tabId:r};chrome.runtime.sendMessage(o)}})),chrome.runtime.onMessage.addListener((e=>{if("offscreen"===e.target)switch(e.type){case"scrollCaptureStartOffscreenRecording":!async function(e){if(r=e.tabId,"recording"===o?.state)throw new Error("Called startRecording while recording is in progress.");console.log("startRecording",JSON.stringify(e));const t={x:e.tabWidth,y:e.tabHeight},d=e.pixelRatio;let l,g={};if("tab"===e.mediaSource){const o=[{width:Math.floor(t.x),height:Math.floor(t.y)},{width:Math.floor(t.x*e.zoomLevel),height:Math.floor(t.y*e.zoomLevel)},{width:Math.floor(t.x*d),height:Math.floor(t.y*d)}];o.sort(((e,o)=>e.width*e.height-o.width*o.height)),console.log("constraintSizes",o),e.exportVideo&&(g.video={mandatory:{chromeMediaSource:e.mediaSource,chromeMediaSourceId:e.streamId,minWidth:o[0].width,minHeight:o[0].height,maxWidth:o[2].width,maxHeight:o[2].height,minFrameRate:30,maxFrameRate:60}}),e.exportAudio&&(g.audio={mandatory:{chromeMediaSource:e.mediaSource,chromeMediaSourceId:e.streamId}}),console.log("navigator.mediaDevices.getUserMedia",JSON.stringify(g));try{l=await navigator.mediaDevices.getUserMedia(g)}catch(e){console.log("navigator.mediaDevices.getUserMedia error",e)}}else{g={video:{displaySurface:"monitor"},audio:{suppressLocalAudioPlayback:!0,autoGainControl:!1,echoCancellation:!1,gooAutoGainControl:!1,noiseSuppression:!1},preferCurrentTab:!1,selfBrowserSurface:"exclude",systemAudio:"include",surfaceSwitching:"include",monitorTypeSurfaces:"include"},console.log("navigator.mediaDevices.getDisplayMedia",JSON.stringify(g));try{l=await navigator.mediaDevices.getDisplayMedia(g)}catch(e){console.log("navigator.mediaDevices.getDisplayMedia error",e)}}if(console.log("media=",l),!l)return console.log("!!!!No media"),void s(e.tabId);const u=l.getAudioTracks();if(e.exportAudio&&u.length>0){const e=new AudioContext;e.createMediaStreamSource(l).connect(e.destination)}if(!e.exportVideo&&e.exportAudio&&u.length<1)return console.log("!!!!No audio track"),l.getTracks().forEach((e=>e.stop())),void s(e.tabId);let h,m=e.format,f=e.audioCodec;e.needsFFMPEG&&(m="webm",f="pcm");e.exportVideo?(h=`video/${m};codecs=${e.videoCodec}`,e.exportAudio&&(h+=`,${f}`)):h=`audio/${m};codecs=${f}`;let p=e.videoBitsPerSecond||16,w=e.audioBitsPerSecond||128;const y={mimeType:h,audioBitsPerSecond:1e3*w,videoBitsPerSecond:1e6*p};console.log("MediaRecorder",JSON.stringify(y)),o=new MediaRecorder(l,y),o.ondataavailable=e=>a.push(e.data),o.onstop=()=>{const o=h.split(";")[0];i=new Blob(a,{type:o}),e.needsFFMPEG?function(e,o){var t=new FileReader;t.onload=async function(){let e="sample_video.webm",t=`sample_video.${o.extension}`,i=`ffmpeg -i ${e}`;o.exportVideo&&(i+=" -c:v copy"),o.exportAudio&&(i+=` -c:a ${o.audioCodec} -b:a ${o.audioBitsPerSecond}k`),i+=` ${t}`;const r=await async function(e,o,t,i){n.isLoaded()&&await n.exit();await n.load();const r=t.split(" ");if("ffmpeg"!==r.shift())return void alert("Please start with ffmpeg");n.FS("writeFile",e,await FFmpeg.fetchFile(i)),await n.run(...r);const a=n.FS("readFile",o),s=new Blob([a.buffer]);return s}(e,t,i,new Uint8Array(this.result));c(r,o)},t.readAsArrayBuffer(e)}(i,e):c(i,e),a=[]},o.start(),window.location.hash="recording"}(e);break;case"scrollCaptureStopOffscreenRecording":o.stop(),o.stream.getTracks().forEach((e=>e.stop())),o=void 0,window.location.hash="";break;default:throw new Error("Unrecognized message:",e.type)}}))})();