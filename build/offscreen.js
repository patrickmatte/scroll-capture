(()=>{"use strict";function e(e){return e<10?"0"+e:e.toString()}function t(t){let o=t.getHours(),i=o>=12?"pm":"am";return o%=12,o=o||12,{hours:o,minutes:e(t.getMinutes()),seconds:e(t.getSeconds()),ampm:i}}let o;function i(o){const i=function(){let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ScrollCapture",i=new Date,r=t(i),a={year:i.getFullYear(),month:e(i.getMonth()+1),date:e(i.getDate())};return r.ampm=r.ampm.toUpperCase(),`${o} ${a.year}-${a.month}-${a.date} at ${r.hours}.${r.minutes}.${r.seconds} ${r.ampm}`}(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ScrollCapture");return`${i}.${o}`}let r,a,n=[];const s=FFmpeg.createFFmpeg({corePath:chrome.runtime.getURL("ffmpeg-core.js"),log:!1,mainName:"main"});function d(e,t){const o={type:"scrollCaptureVideoURLBackground",videoURL:URL.createObjectURL(e),fileName:i(t.extension),tabId:t.tabId,mimeType:t.exportVideo?"video":"audio/"+t.extension};chrome.runtime.sendMessage(o)}s.setProgress((e=>{console.log("progress:",e)})),s.setLogger((e=>{switch(e.type){case"fferr":case"ffout":const t={type:"scrollCaptureFFmpegLogToSW",logType:e.type,message:e.message,tabId:a};chrome.runtime.sendMessage(t)}})),chrome.runtime.onMessage.addListener((e=>{if("offscreen"===e.target)switch(e.type){case"scrollCaptureStartOffscreenRecording":!async function(e){if(a=e.tabId,"recording"===o?.state)throw new Error("Called startRecording while recording is in progress.");console.log("startRecording",JSON.stringify(e));const t={x:e.tabWidth,y:e.tabHeight},i=e.pixelRatio,c={},l=[{width:Math.floor(t.x),height:Math.floor(t.y)},{width:Math.floor(t.x*e.zoomLevel),height:Math.floor(t.y*e.zoomLevel)},{width:Math.floor(t.x*i),height:Math.floor(t.y*i)}];l.sort(((e,t)=>e.width*e.height-t.width*t.height)),console.log("constraintSizes",l),e.exportVideo&&(c.video={mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e.streamId,minWidth:l[0].width,minHeight:l[0].height,maxWidth:l[2].width,maxHeight:l[2].height,minFrameRate:30,maxFrameRate:60}});e.exportAudio&&(c.audio={mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e.streamId}});let m;console.log("navigator.mediaDevices.getUserMedia",JSON.stringify(c));try{m=await navigator.mediaDevices.getUserMedia(c)}catch(e){console.log("navigator.mediaDevices.getUserMedia error",e)}if(console.log("media=",m),e.exportAudio){const e=new AudioContext;e.createMediaStreamSource(m).connect(e.destination)}let g,h=e.format,u=e.audioCodec;e.needsFFMPEG&&(h="webm",u="pcm");e.exportVideo?(g=`video/${h};codecs=${e.videoCodec}`,e.exportAudio&&(g+=`,${u}`)):g=`audio/${h};codecs=${u}`;let p=e.videoBitsPerSecond||16,f=e.audioBitsPerSecond||128;const w={mimeType:g,audioBitsPerSecond:1e3*f,videoBitsPerSecond:1e6*p};console.log("MediaRecorder",JSON.stringify(w)),o=new MediaRecorder(m,w),o.ondataavailable=e=>n.push(e.data),o.onstop=()=>{const t=g.split(";")[0];r=new Blob(n,{type:t});e.needsFFMPEG?function(e,t){var o=new FileReader;o.onload=async function(){let e="sample_video.webm",o=`sample_video.${t.extension}`,i=`ffmpeg -i ${e}`;t.exportVideo&&(i+=" -c:v copy"),t.exportAudio&&(i+=` -c:a ${t.audioCodec} -b:a ${t.audioBitsPerSecond}k`),i+=` ${o}`;const r=await async function(e,t,o,i){s.isLoaded()&&await s.exit();await s.load();const r=o.split(" ");if("ffmpeg"!==r.shift())return void alert("Please start with ffmpeg");s.FS("writeFile",e,await FFmpeg.fetchFile(i)),await s.run(...r);const a=s.FS("readFile",t),n=new Blob([a.buffer]);return n}(e,o,i,new Uint8Array(this.result));d(r,t)},o.readAsArrayBuffer(e)}(r,e):d(r,e),n=[]},o.start(),window.location.hash="recording"}(e);break;case"scrollCaptureStopOffscreenRecording":o.stop(),o.stream.getTracks().forEach((e=>e.stop())),o=void 0,window.location.hash="";break;default:throw new Error("Unrecognized message:",e.type)}}))})();